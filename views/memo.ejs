
<section class="grid-2">
  <div>
    <h2><%= memo.title %></h2>
    <% if (memo.description) { %>
      <p class="muted"><%= memo.description %></p>
    <% } %>
    <div style="margin:6px 0 12px 0;display:flex;gap:6px;align-items:center;">
      <span class="badge"><%= (memo.status || 'open').toUpperCase() %></span>
      <% if ((memo.importance || 'normal') === 'action') { %>
        <span class="badge" style="background:#d83a3a;">ACTION REQUIRED</span>
      <% } %>
    </div>
    <div class="doc-preview">
      <%- docHtml %>
    </div>
    <div class="actions" style="margin-top:8px;display:flex;gap:8px;align-items:center;">
      <a class="btn small" href="/memo/<%= memo.id %>/download">Download .docx</a>
      <span class="muted">Source: <%= memo.originalFileName %></span>
    </div>
  </div>
  <div>
    <h3>Replies</h3>
    <% if (!memo.replies.length) { %>
      <p class="muted">No replies yet.</p>
    <% } else { %>
      <ul class="list">
        <% memo.replies.forEach(r => { %>
          <li class="list-item">
            <div>
              <strong><%= r.sender === 'manager' ? 'Manager' : r.sender %></strong>
              <div class="muted"><%= new Date(r.createdAt).toLocaleString() %></div>
              <div><%= r.message %></div>
            </div>
          </li>
        <% }) %>
      </ul>
    <% } %>

    <% if (isManagerViewer) { %>
      <h3>Send a Reply</h3>
      <form action="/memo/<%= memo.id %>/reply" method="post" class="form-grid">
        <input type="hidden" name="email" value="<%= viewerEmail %>" />
        <label>Message</label>
        <textarea name="message" rows="4" required><%= prefillMessage || '' %></textarea>
        <button class="btn" type="submit">Send Reply</button>
      </form>
    <% } %>

    <% if (isHRViewer) { %>
      <h3>Reply as HR</h3>
      <form action="/memo/<%= memo.id %>/reply" method="post" class="form-grid">
        <input type="hidden" name="email" value="<%= viewerEmail %>" />
        <label>Message</label>
        <textarea name="message" rows="4" required><%= prefillMessage || '' %></textarea>
        <button class="btn" type="submit">Send Reply</button>
      </form>
    <% } %>

    <% if (!isManagerViewer && !isHRViewer) { %>
      <p class="muted">Only the assigned manager (<%= memo.managerEmail %>) or HR (<%= memo.hrEmail %>) can send a reply.</p>
    <% } %>
  </div>
</section>
